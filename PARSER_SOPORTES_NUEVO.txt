// REEMPLAZO PARA server.js - L√çNEAS 371-434
// Copiar y pegar este bloque completo reemplazando el bloque actual de "C√ÅLCULO PROPORCIONAL DE SOPORTES"

            // =========================================================
            // C√ÅLCULO REAL DE SOPORTES (PARSER DE G-CODE COMPLETO)
            // =========================================================
            
            let pesoSoportes = 0;
            
            // 1. Obtener longitud total de filamento (dato confiable del resumen)
            let totalFilamentMm = 0;
            const matchTotalMm = gcodeContent.match(/; filament used \[mm\] = (\d+(\.\d+)?)/);
            if (matchTotalMm) {
                totalFilamentMm = parseFloat(matchTotalMm[1]);
                console.log(`   üìè Total Filamento detectado: ${totalFilamentMm.toFixed(1)} mm`);
            } else {
                console.log(`   ‚ö†Ô∏è No se detect√≥ "filament used [mm]" en el G-code`);
            }
            
            // 2. Analizar G-code l√≠nea por l√≠nea para detectar secciones de soporte
            // PrusaSlicer marca secciones con: ";TYPE:Support material" o ";TYPE:Support material interface"
            let supportExtrusionMm = 0;
            let currentMode = null;
            let lastE = 0; // √öltimo valor E absoluto
            let isRelativeE = false; // Si usa modo relativo (M83)
            
            const lines = gcodeContent.split('\n');
            
            for (const line of lines) {
                const trimmed = line.trim();
                
                // Detectar cambio de modo
                if (trimmed.startsWith(';TYPE:')) {
                    currentMode = trimmed.substring(6).toLowerCase();
                    continue;
                }
                
                // Detectar modo de extrusi√≥n
                if (trimmed === 'M82') {
                    isRelativeE = false; // Modo absoluto
                    continue;
                } else if (trimmed === 'M83') {
                    isRelativeE = true; // Modo relativo
                    continue;
                }
                
                // Si estamos en modo soporte, sumar extrusi√≥n
                if (currentMode && currentMode.includes('support')) {
                    // Buscar comandos G1 con extrusi√≥n (E)
                    const matchE = trimmed.match(/G1\s.*E([\d.-]+)/i);
                    if (matchE) {
                        const eValue = parseFloat(matchE[1]);
                        
                        if (isRelativeE) {
                            // Modo relativo: E es la cantidad extruida en este movimiento
                            if (eValue > 0) { // Solo sumas positivas (no retracciones)
                                supportExtrusionMm += eValue;
                            }
                        } else {
                            // Modo absoluto: E es posici√≥n acumulada
                            if (eValue > lastE) {
                                supportExtrusionMm += (eValue - lastE);
                            }
                            lastE = eValue;
                        }
                    }
                } else if (!currentMode || !currentMode.includes('support')) {
                    // Si no estamos en soporte, actualizar lastE para modo absoluto
                    const matchE = trimmed.match(/G1\s.*E([\d.-]+)/i);
                    if (matchE && !isRelativeE) {
                        lastE = parseFloat(matchE[1]);
                    }
                }
            }
            
            console.log(`   üîç Extrusi√≥n de soporte detectada: ${supportExtrusionMm.toFixed(1)} mm (de G-code real)`);
            
            // 3. Aplicar M√©todo Proporcional con el dato real
            if (pesoTotal > 0 && totalFilamentMm > 0 && supportExtrusionMm > 0) {
                // F√≥rmula: PesoSoportes = PesoTotal √ó (ExtrusionSoporte / TotalFilamento)
                const ratio = supportExtrusionMm / totalFilamentMm;
                pesoSoportes = pesoTotal * ratio;
                
                console.log(`   üìê M√©todo Proporcional (Real):`);
                console.log(`      Total Filamento: ${totalFilamentMm.toFixed(1)} mm`);
                console.log(`      Soporte Real: ${supportExtrusionMm.toFixed(1)} mm`);
                console.log(`      Ratio: ${(ratio * 100).toFixed(1)}%`);
                console.log(`      ‚úì Peso Soportes: ${pesoSoportes.toFixed(2)}g (${(ratio * 100).toFixed(1)}% del total)`);
            } else if (supportExtrusionMm === 0) {
                // No hay soportes en este modelo
                console.log(`   ‚úì Modelo sin soportes (confirmado por an√°lisis G-code)`);
            } else {
                // Fallback: Si no tenemos datos de longitud total, intentar volumen
                const matchSupportVol = gcodeContent.match(/; support material(?: volume)?.*?[:=]\s*(\d+(\.\d+)?)\s*cm3/i);
                if (matchSupportVol && volumen > 0) {
                    const supportVol = parseFloat(matchSupportVol[1]);
                    const volRatio = supportVol / volumen;
                    pesoSoportes = pesoTotal * volRatio;
                    console.log(`   ‚ö†Ô∏è Fallback (Volumen): Soportes ${pesoSoportes.toFixed(2)}g`);
                }
            }
